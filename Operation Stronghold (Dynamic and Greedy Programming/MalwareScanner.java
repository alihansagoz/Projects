import java.io.FileInputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.util.Map;
import java.util.Scanner;

public class MalwareScanner {

    private final Map<String, Malware> malwareDB;

    public MalwareScanner(Map<String, Malware> malwareDB) {
        this.malwareDB = malwareDB;
    }

    public void scanFile(String filename) throws IOException {
        FileWriter myWriter = new FileWriter("scanLog.txt");
        int numberofenemies = 0;
        System.out.println("Started scanning...");
        System.out.println("--------------------------------------------------------------------------------");
        FileInputStream fis=new FileInputStream(filename);
        Scanner sc=new Scanner(fis);
        int line = 0;
        while(sc.hasNextLine())
        {
            line++;
            Malware malware = malwareDB.get(turbo64(sc.nextLine()));
            if (malware != null){
                numberofenemies++;
                System.out.println("Detected malware!");
                System.out.println(malware);
                myWriter.write(malware.getHash());
                myWriter.write("@");
                myWriter.write(String.valueOf(line));
                myWriter.write("\n");
                System.out.println("--------------------------------------------------------------------------------");
            }
        }
        myWriter.close();
        System.out.println("Scan complete! "+ numberofenemies+ " threats are found and eliminated. Generating log file...");
    }

    public static String turbo64(String in) {

        long MOD_TURBO = 4294967291L;
        long a = 0;
        long b = 1;
        for (int i =0; i<in.length(); i++ ){
            char c = in.charAt(i);
            a = (a+(int) (c) ) % MOD_TURBO;
            b = (a + b) % MOD_TURBO;
        }
        long returnValue = b << 32;
        returnValue = returnValue | a ;
        return Long.toHexString(returnValue);

    }
}
